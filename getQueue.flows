[{"id":"71cae25a.fbf07c","type":"function","z":"76cff903.f62f88","name":"Begär/skicka data när pumpen tillåter","func":"var config = flow.get(\"nibe_config\");\nvar sendQueue = context.get('sendQueue')||[];\nvar getQueue = context.get('getQueue')||[];\nvar waitResponse = context.get('waitResponse')||undefined;\nvar timeOut = context.get('timeOut')||0;\nvar address = (msg.payload[6]*256+msg.payload[5]);\nif (address==waitResponse)  {\n//    node.warn('Response received: '+address);\n    context.set('waitResponse',undefined);\n    timeOut = 0;\n} else if(msg.payload[3]==105 && waitResponse===undefined) {\nif(getQueue.length!==0) {\n    var lastMsg = getQueue.pop();\n    node.send(lastMsg);\n    context.set('getQueue',getQueue);\n    var getTopic = lastMsg.topic.split(\"/\");\n    context.set('waitResponse',getTopic[2]);\n} else {\nvar updateRegisters = flow.get(\"nibe_update_registers\")||getRegisters();\nvar n = context.get('n')||0;\nnode.send({topic:config.defaultTopic+updateRegisters[n]+\"/get\",payload:true});\ncontext.set('waitResponse',updateRegisters[n]);\nn++;\nif(n>(updateRegisters.length)) {\n    n = 0;\n}\ncontext.set('n',n)\n}\n} else if(msg.payload[3]==107) {\n    if(sendQueue.length!==0) {\n        var lastMsg = sendQueue.pop();\n        node.send(lastMsg);\n        context.set('sendQueue',sendQueue);\n    }\n} else {\n    if(msg.topic!==undefined) {\n    var topic = msg.topic.split(\"/\");\n    if(topic[3]==\"set\") {\n        var sendMsg = {topic:msg.topic,payload:msg.payload};\n        sendQueue.push(sendMsg);\n        context.set('sendQueue',sendQueue);\n    } else if(topic[3]==\"get\") {\n        var getMsg = {topic:msg.topic,payload:msg.payload};\n        getQueue.push(getMsg);\n        context.set('getQueue',getQueue);\n    }\n}\n}\ntimeOut++;\ncontext.set('timeOut',timeOut);\nif(timeOut>20) {\n    timeOut = 0;\n    node.warn('Error, timeout. Resetting');\n}\nfunction getRegisters() {\n    node.warn(\"Requesting registers\");\n    node.send([null,msg]);\n}","outputs":2,"noerr":0,"x":430,"y":440,"wires":[["ae8db2d2.5975a","ab07ac67.c68d2"],[]]}]
